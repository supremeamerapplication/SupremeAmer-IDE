<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SupremeAmer IDE Pro - Advanced Web IDE</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SupremeAmer IDE">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#2c3e50" id="theme-color">
    <meta name="msapplication-navbutton-color" content="#2c3e50">
    
    <!-- Security Headers (meta equivalent) -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; font-src 'self' https://cdnjs.cloudflare.com; connect-src 'self' https:; frame-src 'self' blob:; img-src 'self' data: https:; worker-src 'self' blob:;">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" href="/icons/icon-32.png">
    
    <!-- CSS Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Core Styles -->
    <style>
        /* CSS Variables */
        :root {
            --primary: #2c3e50;
            --primary-dark: #1e2b37;
            --secondary: #4a69bd;
            --secondary-dark: #3a539b;
            --success: #00b894;
            --success-dark: #009d7a;
            --warning: #e17055;
            --warning-dark: #d15b3f;
            --info: #6c5ce7;
            --info-dark: #5649c9;
            --danger: #d63031;
            --danger-dark: #b71c1c;
            --dark: #2d3436;
            --light: #f8f9fa;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            
            --html: #e34c26;
            --css: #264de4;
            --js: #f0db4f;
            --python: #3776ab;
            --php: #777bb4;
            --java: #007396;
            --cpp: #00599c;
            --csharp: #239120;
            --go: #00add8;
            --rust: #000000;
            --ruby: #cc342d;
            --swift: #fa7343;
            --typescript: #3178c6;
            
            --sidebar-width: 280px;
            --sidebar-collapsed-width: 0;
            --header-height: 64px;
            --footer-height: 32px;
            --border-radius: 8px;
            --transition-speed: 0.3s;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --primary: #1a1a2e;
            --primary-dark: #0f0f1a;
            --secondary: #16213e;
            --secondary-dark: #0f1a2f;
            --dark: #121212;
            --light: #2d3436;
            --gray-100: #2d3436;
            --gray-200: #3c4345;
            --gray-300: #4a5153;
            --gray-400: #5a6268;
            --gray-500: #6c757d;
            --gray-600: #868e96;
            --gray-700: #a1a8b0;
            --gray-800: #c1c9d0;
            --gray-900: #e9ecef;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #f1f2f6;
        }

        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            padding: 10px;
            display: flex;
            flex-direction: column;
            transition: background-color var(--transition-speed) ease;
        }

        /* Layout */
        .app-container {
            max-width: 1800px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.98);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 20px);
            transition: background-color var(--transition-speed) ease;
        }

        body.dark-mode .app-container {
            background-color: rgba(45, 52, 54, 0.98);
        }

        /* Header */
        .app-header {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            padding: 0 20px;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            position: relative;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo i {
            font-size: 2rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            white-space: nowrap;
        }

        .header-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* Buttons */
        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--success);
            border-color: var(--success-dark);
        }

        .btn-primary:hover {
            background: var(--success-dark);
        }

        .btn-secondary {
            background: var(--info);
            border-color: var(--info-dark);
        }

        .btn-danger {
            background: var(--danger);
            border-color: var(--danger-dark);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--gray-100);
            border-right: 1px solid var(--gray-300);
            display: flex;
            flex-direction: column;
            transition: width var(--transition-speed) ease;
            overflow: hidden;
            position: relative;
            z-index: 90;
        }

        .sidebar.collapsed {
            width: 0;
        }

        @media (max-width: 992px) {
            .sidebar {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 1000;
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            }
            
            .sidebar.collapsed {
                left: -100%;
            }
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--gray-300);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--gray-200);
        }

        .file-actions {
            padding: 10px;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--gray-300);
        }

        .file-action-btn {
            padding: 6px 10px;
            font-size: 0.8rem;
            background: white;
            border: 1px solid var(--gray-400);
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            color: var(--gray-700);
        }

        .file-action-btn:hover {
            background: var(--gray-200);
            border-color: var(--gray-500);
        }

        .file-action-btn.danger:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger-dark);
        }

        /* File Explorer */
        .file-explorer {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* File Tree */
        .file-tree {
            list-style: none;
            padding-left: 20px;
        }

        .file-tree-item {
            margin: 2px 0;
            user-select: none;
        }

        .file-tree-folder {
            font-weight: 600;
            color: var(--gray-700);
        }

        .file-tree-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .file-tree-header:hover {
            background: var(--gray-200);
        }

        .file-tree-header i {
            font-size: 0.9rem;
            color: var(--gray-500);
            transition: transform 0.2s;
        }

        .file-tree-header.expanded i {
            transform: rotate(90deg);
        }

        .file-tree-children {
            list-style: none;
            padding-left: 20px;
            display: none;
        }

        .file-tree-children.expanded {
            display: block;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px 6px 28px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            color: var(--gray-700);
        }

        .file-item:hover {
            background: var(--gray-200);
        }

        .file-item.active {
            background: var(--gray-300);
            font-weight: 600;
            color: var(--primary);
        }

        .file-item.dragover {
            background: var(--info);
            color: white;
            opacity: 0.8;
        }

        .file-item i {
            width: 16px;
            text-align: center;
        }

        .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-size {
            font-size: 0.7rem;
            color: var(--gray-500);
            padding: 2px 6px;
            background: var(--gray-200);
            border-radius: 10px;
        }

        .file-actions-menu {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
            gap: 5px;
            background: white;
            padding: 2px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .file-item:hover .file-actions-menu {
            display: flex;
        }

        .file-action-icon {
            padding: 4px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7rem;
        }

        .file-action-icon:hover {
            background: var(--gray-300);
        }

        /* Editor Area */
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-tabs {
            display: flex;
            background: var(--gray-100);
            border-bottom: 1px solid var(--gray-300);
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .editor-tab {
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 600;
            border-right: 1px solid var(--gray-300);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            background: var(--gray-200);
            transition: all 0.2s;
            min-width: 120px;
            max-width: 200px;
            position: relative;
        }

        .editor-tab.active {
            background: white;
            border-bottom: 3px solid var(--secondary);
            margin-bottom: -1px;
        }

        .dark-mode .editor-tab.active {
            background: var(--gray-800);
        }

        .editor-tab .tab-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .editor-tab .tab-close {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 0.8rem;
            opacity: 0.5;
            transition: all 0.2s;
        }

        .editor-tab .tab-close:hover {
            opacity: 1;
            background: var(--danger);
            color: white;
        }

        .editor-tab.modified .tab-name::after {
            content: '•';
            margin-left: 4px;
            color: var(--warning);
        }

        /* Editor Container */
        .editor-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .editor-wrapper {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-wrapper.active {
            display: flex;
        }

        .editor-header {
            padding: 8px 12px;
            background: var(--gray-100);
            border-bottom: 1px solid var(--gray-300);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .monaco-editor-container {
            flex: 1;
            overflow: hidden;
        }

        /* Preview Panel */
        .preview-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--gray-300);
            background: white;
            transition: width 0.2s;
        }

        .preview-panel.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100vh;
            z-index: 2000;
            border: none;
        }

        .preview-header {
            padding: 10px 15px;
            background: var(--gray-100);
            border-bottom: 1px solid var(--gray-300);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-controls {
            display: flex;
            gap: 8px;
        }

        .preview-frame {
            flex: 1;
            border: none;
            background: white;
            width: 100%;
            transition: all 0.2s;
        }

        .preview-frame.mobile-view {
            max-width: 375px;
            margin: 0 auto;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        /* Console Panel */
        .console-panel {
            height: 200px;
            border-top: 1px solid var(--gray-300);
            display: flex;
            flex-direction: column;
            background: var(--gray-900);
        }

        .console-header {
            padding: 8px 15px;
            background: var(--gray-800);
            color: var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .console-output {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            color: var(--gray-200);
            background: var(--gray-900);
        }

        .console-line {
            padding: 2px 0;
            border-bottom: 1px solid var(--gray-800);
            white-space: pre-wrap;
            word-break: break-all;
        }

        .console-line.error {
            color: #ff7675;
        }

        .console-line.warn {
            color: #fdcb6e;
        }

        .console-line.info {
            color: #74b9ff;
        }

        .console-line.success {
            color: #55efc4;
        }

        .console-timestamp {
            color: var(--gray-500);
            font-size: 0.7rem;
            margin-right: 8px;
        }

        /* Resizer */
        .resizer {
            width: 5px;
            background: var(--gray-300);
            cursor: col-resize;
            transition: background 0.2s;
            position: relative;
        }

        .resizer:hover,
        .resizer.resizing {
            background: var(--secondary);
        }

        .resizer.horizontal {
            width: 100%;
            height: 5px;
            cursor: row-resize;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.show {
            display: flex;
            opacity: 1;
        }

        .modal {
            background: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: translateY(0);
        }

        .dark-mode .modal {
            background: var(--gray-800);
            color: var(--gray-200);
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--gray-300);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--gray-300);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .close-modal:hover {
            opacity: 1;
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .dark-mode .form-group label {
            color: var(--gray-300);
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gray-400);
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.2s;
            background: white;
        }

        .dark-mode .form-control {
            background: var(--gray-700);
            border-color: var(--gray-600);
            color: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(74, 105, 189, 0.2);
        }

        /* Language Grid */
        .language-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .language-option {
            padding: 10px;
            border: 2px solid var(--gray-300);
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--gray-100);
        }

        .language-option:hover {
            border-color: var(--secondary);
            background: var(--gray-200);
        }

        .language-option.selected {
            border-color: var(--secondary);
            background: rgba(74, 105, 189, 0.1);
            font-weight: 600;
        }

        .dark-mode .language-option {
            background: var(--gray-700);
            border-color: var(--gray-600);
            color: var(--gray-300);
        }

        .language-icon {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        /* Notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 4000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .notification {
            padding: 12px 16px;
            border-radius: 6px;
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            border-left: 4px solid;
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        .notification.warning {
            border-left-color: var(--warning);
        }

        .notification.info {
            border-left-color: var(--info);
        }

        .notification i {
            font-size: 1.2rem;
        }

        .notification.success i {
            color: var(--success);
        }

        .notification.error i {
            color: var(--danger);
        }

        .notification.warning i {
            color: var(--warning);
        }

        .notification.info i {
            color: var(--info);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .notification-message {
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        .notification-close {
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .notification-close:hover {
            opacity: 1;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Progress Bar */
        .progress-bar {
            height: 4px;
            background: var(--gray-200);
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary), var(--info));
            width: 0%;
            transition: width 0.3s;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Drop Zone */
        .drop-zone {
            border: 2px dashed var(--gray-400);
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--gray-100);
            margin: 15px 0;
        }

        .drop-zone.dragover {
            border-color: var(--secondary);
            background: rgba(74, 105, 189, 0.1);
        }

        .drop-zone i {
            font-size: 3rem;
            color: var(--secondary);
            margin-bottom: 10px;
        }

        /* Footer */
        .app-footer {
            text-align: center;
            padding: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.8rem;
            background: rgba(0, 0, 0, 0.2);
            height: var(--footer-height);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-indicator.online {
            background: rgba(0, 184, 148, 0.2);
            color: var(--success);
        }

        .status-indicator.offline {
            background: rgba(225, 112, 85, 0.2);
            color: var(--warning);
        }

        .status-indicator i {
            font-size: 0.7rem;
        }

        /* Auto-save Indicator */
        .auto-save-indicator {
            position: fixed;
            bottom: 50px;
            left: 20px;
            background: var(--success);
            color: white;
            padding: 8px 15px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .auto-save-indicator.show {
            display: flex;
            animation: slideUp 0.3s ease;
        }

        /* Responsive */
        @media (max-width: 768px) {
            :root {
                --header-height: 56px;
                --footer-height: 28px;
            }

            .logo h1 {
                font-size: 1.2rem;
            }

            .btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }

            .btn span {
                display: none;
            }

            .editor-tabs {
                font-size: 0.85rem;
            }

            .editor-tab {
                padding: 8px 10px;
                min-width: 100px;
            }

            .preview-panel {
                width: 100%;
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 1500;
                display: none;
            }

            .preview-panel.active {
                display: flex;
            }

            .console-panel {
                height: 150px;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-2 {
            gap: 8px;
        }

        .gap-4 {
            gap: 16px;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-lg {
            font-size: 1.125rem;
        }

        .font-bold {
            font-weight: 700;
        }

        .text-danger {
            color: var(--danger);
        }

        .text-success {
            color: var(--success);
        }

        .text-warning {
            color: var(--warning);
        }

        .text-info {
            color: var(--info);
        }

        .bg-primary {
            background: var(--primary);
        }

        .bg-secondary {
            background: var(--secondary);
        }

        .rounded {
            border-radius: 4px;
        }

        .mt-2 {
            margin-top: 8px;
        }

        .mb-2 {
            margin-bottom: 8px;
        }

        .p-2 {
            padding: 8px;
        }

        .p-4 {
            padding: 16px;
        }
    </style>
</head>
<body>
    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- Auto-save Indicator -->
    <div id="auto-save-indicator" class="auto-save-indicator">
        <i class="fas fa-save"></i>
        <span>Saving...</span>
    </div>

    <!-- Main App Container -->
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="logo">
                <i class="fas fa-code"></i>
                <h1>SupremeAmer IDE Pro</h1>
            </div>
            
            <div class="header-controls">
                <button class="btn" id="toggle-sidebar" title="Toggle Sidebar">
                    <i class="fas fa-bars"></i>
                    <span>Explorer</span>
                </button>
                
                <button class="btn btn-primary" id="run-code" title="Run Code (Ctrl+Enter)">
                    <i class="fas fa-play"></i>
                    <span>Run</span>
                </button>
                
                <button class="btn btn-secondary" id="save-file" title="Save File (Ctrl+S)">
                    <i class="fas fa-save"></i>
                    <span>Save</span>
                </button>
                
                <button class="btn" id="new-file" title="New File">
                    <i class="fas fa-file"></i>
                    <span>New File</span>
                </button>
                
                <button class="btn" id="new-folder" title="New Folder">
                    <i class="fas fa-folder-plus"></i>
                    <span>New Folder</span>
                </button>
                
                <button class="btn" id="upload-files" title="Upload Files">
                    <i class="fas fa-upload"></i>
                    <span>Upload</span>
                </button>
                
                <button class="btn" id="export-project" title="Export Project">
                    <i class="fas fa-download"></i>
                    <span>Export</span>
                </button>
                
                <button class="btn" id="toggle-theme" title="Toggle Dark Mode">
                    <i class="fas fa-moon"></i>
                    <span>Dark</span>
                </button>
                
                <button class="btn" id="pwa-settings" title="PWA Settings">
                    <i class="fas fa-mobile-alt"></i>
                    <span>PWA</span>
                </button>
                
                <div id="online-status" class="status-indicator online">
                    <i class="fas fa-circle"></i>
                    <span>Online</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h3><i class="fas fa-folder-open"></i> File Explorer</h3>
                    <button class="btn-outline" id="close-sidebar" title="Close Sidebar">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="file-actions">
                    <button class="file-action-btn" id="sidebar-new-file" title="New File">
                        <i class="fas fa-file"></i> File
                    </button>
                    <button class="file-action-btn" id="sidebar-new-folder" title="New Folder">
                        <i class="fas fa-folder-plus"></i> Folder
                    </button>
                    <button class="file-action-btn" id="sidebar-refresh" title="Refresh">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="file-action-btn danger" id="sidebar-delete" title="Delete Selected" style="display: none;">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
                
                <!-- File Explorer Tree -->
                <div class="file-explorer" id="file-explorer">
                    <div class="text-center p-4 text-sm text-gray-500">
                        <i class="fas fa-spinner fa-spin"></i> Loading files...
                    </div>
                </div>
                
                <!-- Drop Zone -->
                <div class="drop-zone" id="drop-zone">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Drag & drop files or folders</p>
                    <p class="text-sm">or click to browse</p>
                    <input type="file" id="file-input" class="hidden" multiple webkitdirectory>
                </div>
                
                <!-- Storage Info -->
                <div class="p-2 text-sm" id="storage-info">
                    <div class="flex items-center justify-between">
                        <span><i class="fas fa-database"></i> Storage</span>
                        <span id="storage-usage">Calculating...</span>
                    </div>
                    <div class="progress-bar mt-2">
                        <div class="progress" id="storage-progress" style="width: 0%"></div>
                    </div>
                </div>
            </aside>

            <!-- Editor Area -->
            <div class="editor-area">
                <!-- Editor Tabs -->
                <div class="editor-tabs" id="editor-tabs">
                    <!-- Tabs will be added dynamically -->
                </div>

                <!-- Editor Container -->
                <div class="editor-container">
                    <div class="editor-wrapper active" data-language="html">
                        <div class="editor-header">
                            <span><i class="fab fa-html5" style="color: var(--html);"></i> HTML Editor</span>
                            <div class="flex items-center gap-2">
                                <select id="html-theme" class="form-control text-sm" style="width: auto;">
                                    <option value="vs">Light</option>
                                    <option value="vs-dark">Dark</option>
                                    <option value="hc-black">High Contrast</option>
                                </select>
                                <button class="btn-outline" id="format-html" title="Format HTML">
                                    <i class="fas fa-magic"></i>
                                </button>
                            </div>
                        </div>
                        <div id="html-editor" class="monaco-editor-container"></div>
                    </div>
                    
                    <div class="editor-wrapper" data-language="css">
                        <div class="editor-header">
                            <span><i class="fab fa-css3-alt" style="color: var(--css);"></i> CSS Editor</span>
                            <div class="flex items-center gap-2">
                                <button class="btn-outline" id="format-css" title="Format CSS">
                                    <i class="fas fa-magic"></i>
                                </button>
                            </div>
                        </div>
                        <div id="css-editor" class="monaco-editor-container"></div>
                    </div>
                    
                    <div class="editor-wrapper" data-language="javascript">
                        <div class="editor-header">
                            <span><i class="fab fa-js-square" style="color: var(--js);"></i> JavaScript Editor</span>
                            <div class="flex items-center gap-2">
                                <button class="btn-outline" id="format-js" title="Format JavaScript">
                                    <i class="fas fa-magic"></i>
                                </button>
                                <button class="btn-outline" id="lint-js" title="Lint JavaScript">
                                    <i class="fas fa-check-circle"></i>
                                </button>
                            </div>
                        </div>
                        <div id="js-editor" class="monaco-editor-container"></div>
                    </div>
                    
                    <div class="editor-wrapper" data-language="python">
                        <div class="editor-header">
                            <span><i class="fab fa-python" style="color: var(--python);"></i> Python Editor</span>
                            <div class="flex items-center gap-2">
                                <button class="btn-outline" id="run-python" title="Run Python">
                                    <i class="fas fa-play"></i>
                                </button>
                            </div>
                        </div>
                        <div id="python-editor" class="monaco-editor-container"></div>
                    </div>
                </div>

                <!-- Vertical Resizer -->
                <div class="resizer" id="vertical-resizer"></div>

                <!-- Preview Panel -->
                <div class="preview-panel" id="preview-panel">
                    <div class="preview-header">
                        <span><i class="fas fa-play-circle" style="color: var(--success);"></i> Live Preview</span>
                        <div class="preview-controls">
                            <button class="btn-outline" id="refresh-preview" title="Refresh Preview">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn-outline" id="toggle-device" title="Toggle Mobile View">
                                <i class="fas fa-mobile-alt"></i>
                            </button>
                            <button class="btn-outline" id="toggle-preview-fullscreen" title="Fullscreen Preview">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button class="btn-outline" id="close-preview-mobile" class="mobile-only" title="Close Preview">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <iframe id="preview-frame" class="preview-frame" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"></iframe>
                </div>
            </div>
        </div>

        <!-- Horizontal Resizer -->
        <div class="resizer horizontal" id="horizontal-resizer"></div>

        <!-- Console Panel -->
        <div class="console-panel" id="console-panel">
            <div class="console-header">
                <div class="flex items-center gap-2">
                    <i class="fas fa-terminal"></i>
                    <span>Console Output</span>
                    <span class="text-sm" id="console-status"></span>
                </div>
                <div class="flex items-center gap-2">
                    <button class="btn-outline" id="clear-console" title="Clear Console">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="btn-outline" id="toggle-console" title="Toggle Console">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
            </div>
            <div id="console-output" class="console-output"></div>
        </div>

        <!-- Footer -->
        <footer class="app-footer">
            <span>© 2024 SupremeAmer Application Development Organization. All rights reserved.</span>
        </footer>
    </div>

    <!-- New File Modal -->
    <div class="modal-overlay" id="new-file-modal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-file"></i> Create New File</h3>
                <span class="close-modal" onclick="hideModal('new-file-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-file-name">File Name</label>
                    <input type="text" id="new-file-name" class="form-control" placeholder="myfile" value="untitled">
                    <small class="text-sm text-gray-500">Extension will be added automatically</small>
                </div>
                
                <div class="form-group">
                    <label>File Type</label>
                    <div class="language-grid" id="language-grid">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="new-file-folder">Folder (optional)</label>
                    <input type="text" id="new-file-folder" class="form-control" placeholder="path/to/folder">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-outline" onclick="hideModal('new-file-modal')">Cancel</button>
                <button class="btn btn-primary" id="create-file-btn">Create File</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-cog"></i> Settings</h3>
                <span class="close-modal" onclick="hideModal('settings-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Editor Settings</label>
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="setting-auto-save" checked>
                            <span>Auto-save</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="setting-word-wrap" checked>
                            <span>Word Wrap</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Auto-save Interval (seconds)</label>
                    <input type="number" id="setting-auto-save-interval" class="form-control" min="5" max="300" value="30">
                </div>
                
                <div class="form-group">
                <label>Font Size</label>
                    <input type="number" id="setting-font-size" class="form-control" min="10" max="24" value="14">
                </div>
                
                <div class="form-group">
                    <label>Tab Size</label>
                    <select id="setting-tab-size" class="form-control">
                        <option value="2">2 spaces</option>
                        <option value="4" selected>4 spaces</option>
                        <option value="8">8 spaces</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-outline" onclick="hideModal('settings-modal')">Cancel</button>
                <button class="btn btn-primary" id="save-settings">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- PWA Info Modal -->
    <div class="modal-overlay" id="pwa-modal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-mobile-alt"></i> PWA Information</h3>
                <span class="close-modal" onclick="hideModal('pwa-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>App Status</label>
                    <div id="pwa-status" class="p-2 bg-gray-100 rounded">Checking...</div>
                </div>
                
                <div class="form-group">
                    <label>Cache Size</label>
                    <div id="cache-status" class="p-2 bg-gray-100 rounded">Calculating...</div>
                </div>
                
                <div class="form-group">
                    <label>Service Worker</label>
                    <div id="sw-status" class="p-2 bg-gray-100 rounded">Checking...</div>
                </div>
                
                <div class="flex gap-2 mt-4">
                    <button class="btn btn-primary" id="check-updates">
                        <i class="fas fa-sync-alt"></i> Check Updates
                    </button>
                    <button class="btn btn-secondary" id="clear-cache">
                        <i class="fas fa-trash"></i> Clear Cache
                    </button>
                    <button class="btn" id="install-pwa">
                        <i class="fas fa-download"></i> Install
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-outline" onclick="hideModal('pwa-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu" class="context-menu" style="display: none; position: fixed; background: white; border: 1px solid var(--gray-300); border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 5000; min-width: 150px;">
        <div class="context-menu-item" data-action="open">
            <i class="fas fa-folder-open"></i> Open
        </div>
        <div class="context-menu-item" data-action="rename">
            <i class="fas fa-edit"></i> Rename
        </div>
        <div class="context-menu-item" data-action="duplicate">
            <i class="fas fa-copy"></i> Duplicate
        </div>
        <div class="context-menu-item" data-action="delete">
            <i class="fas fa-trash"></i> Delete
        </div>
        <div class="context-menu-item" data-action="download">
            <i class="fas fa-download"></i> Download
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" data-action="copy-path">
            <i class="fas fa-link"></i> Copy Path
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs/loader.js"></script>
    <script src="https://unpkg.com/idb@7.1.1/build/umd.js"></script>
    
    <script>
        // ==================== Configuration ====================
        const CONFIG = {
            APP_NAME: 'SupremeAmer IDE Pro',
            APP_VERSION: '2.0.0',
            DB_NAME: 'SupremeAmerIDE',
            DB_VERSION: 1,
            AUTO_SAVE_INTERVAL: 30000,
            MAX_FILE_SIZE: 10 * 1024 * 1024, // 10MB
            SUPPORTED_LANGUAGES: [
                { id: 'html', name: 'HTML', extension: '.html', icon: 'fab fa-html5', color: '#e34c26' },
                { id: 'css', name: 'CSS', extension: '.css', icon: 'fab fa-css3-alt', color: '#264de4' },
                { id: 'javascript', name: 'JavaScript', extension: '.js', icon: 'fab fa-js-square', color: '#f0db4f' },
                { id: 'python', name: 'Python', extension: '.py', icon: 'fab fa-python', color: '#3776ab' },
                { id: 'php', name: 'PHP', extension: '.php', icon: 'fab fa-php', color: '#777bb4' },
                { id: 'cpp', name: 'C++', extension: '.cpp', icon: 'fas fa-code', color: '#00599c' },
                { id: 'java', name: 'Java', extension: '.java', icon: 'fab fa-java', color: '#007396' },
                { id: 'csharp', name: 'C#', extension: '.cs', icon: 'fas fa-copyright', color: '#239120' },
                { id: 'go', name: 'Go', extension: '.go', icon: 'fab fa-golang', color: '#00add8' },
                { id: 'rust', name: 'Rust', extension: '.rs', icon: 'fas fa-cog', color: '#000000' },
                { id: 'ruby', name: 'Ruby', extension: '.rb', icon: 'fas fa-gem', color: '#cc342d' },
                { id: 'swift', name: 'Swift', extension: '.swift', icon: 'fab fa-swift', color: '#fa7343' },
                { id: 'typescript', name: 'TypeScript', extension: '.ts', icon: 'fas fa-code', color: '#3178c6' },
                { id: 'json', name: 'JSON', extension: '.json', icon: 'fas fa-code', color: '#6c5ce7' },
                { id: 'markdown', name: 'Markdown', extension: '.md', icon: 'fab fa-markdown', color: '#333333' },
                { id: 'plaintext', name: 'Text', extension: '.txt', icon: 'fas fa-file-alt', color: '#666666' }
            ]
        };

        // ==================== Notification System ====================
        class NotificationSystem {
            constructor() {
                this.container = document.getElementById('notification-container');
                this.notifications = new Map();
                this.counter = 0;
            }

            show(message, type = 'info', title = '', duration = 5000) {
                const id = ++this.counter;
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.id = `notification-${id}`;
                
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };

                notification.innerHTML = `
                    <i class="fas ${icons[type] || icons.info}"></i>
                    <div class="notification-content">
                        <div class="notification-title">${title || type.charAt(0).toUpperCase() + type.slice(1)}</div>
                        <div class="notification-message">${message}</div>
                    </div>
                    <span class="notification-close" onclick="notifications.remove(${id})">&times;</span>
                `;

                this.container.appendChild(notification);
                this.notifications.set(id, notification);

                if (duration > 0) {
                    setTimeout(() => this.remove(id), duration);
                }

                return id;
            }

            remove(id) {
                const notification = this.notifications.get(id);
                if (notification) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        notification.remove();
                        this.notifications.delete(id);
                    }, 300);
                }
            }

            success(message, title = 'Success') {
                return this.show(message, 'success', title);
            }

            error(message, title = 'Error') {
                return this.show(message, 'error', title, 8000);
            }

            warning(message, title = 'Warning') {
                return this.show(message, 'warning', title, 6000);
            }

            info(message, title = 'Info') {
                return this.show(message, 'info', title, 4000);
            }
        }

        // ==================== Database Service ====================
        class DatabaseService {
            constructor() {
                this.db = null;
                this.ready = false;
                this.initPromise = this.init();
            }

            async init() {
                try {
                    this.db = await idb.openDB(CONFIG.DB_NAME, CONFIG.DB_VERSION, {
                        upgrade(db) {
                            if (!db.objectStoreNames.contains('files')) {
                                const fileStore = db.createObjectStore('files', { keyPath: 'path' });
                                fileStore.createIndex('by_type', 'type');
                                fileStore.createIndex('by_modified', 'modified');
                                fileStore.createIndex('by_folder', 'folder');
                            }
                            
                            if (!db.objectStoreNames.contains('folders')) {
                                const folderStore = db.createObjectStore('folders', { keyPath: 'path' });
                                folderStore.createIndex('by_parent', 'parent');
                            }
                            
                            if (!db.objectStoreNames.contains('settings')) {
                                db.createObjectStore('settings');
                            }
                            
                            if (!db.objectStoreNames.contains('sessions')) {
                                db.createObjectStore('sessions', { keyPath: 'id', autoIncrement: true });
                            }
                        }
                    });
                    
                    this.ready = true;
                    console.log('Database initialized');
                    return true;
                } catch (error) {
                    console.error('Failed to initialize database:', error);
                    return false;
                }
            }

            async ensureReady() {
                if (!this.ready) {
                    await this.initPromise;
                }
            }

            // File operations
            async getFile(path) {
                await this.ensureReady();
                return await this.db.get('files', path);
            }

            async getAllFiles() {
                await this.ensureReady();
                return await this.db.getAll('files');
            }

            async saveFile(file) {
                await this.ensureReady();
                file.modified = Date.now();
                file.size = new Blob([file.content || '']).size;
                return await this.db.put('files', file);
            }

            async deleteFile(path) {
                await this.ensureReady();
                return await this.db.delete('files', path);
            }

            async getFilesInFolder(folderPath) {
                await this.ensureReady();
                const files = await this.getAllFiles();
                return files.filter(f => {
                    if (!folderPath) return !f.path.includes('/');
                    return f.path.startsWith(folderPath + '/');
                });
            }

            // Folder operations
            async getFolder(path) {
                await this.ensureReady();
                return await this.db.get('folders', path);
            }

            async getAllFolders() {
                await this.ensureReady();
                return await this.db.getAll('folders');
            }

            async saveFolder(folder) {
                await this.ensureReady();
                folder.modified = Date.now();
                return await this.db.put('folders', folder);
            }

            async deleteFolder(path) {
                await this.ensureReady();
                
                // Delete all files in folder
                const files = await this.getFilesInFolder(path);
                for (const file of files) {
                    await this.deleteFile(file.path);
                }
                
                // Delete subfolders
                const folders = await this.getAllFolders();
                const subFolders = folders.filter(f => f.path.startsWith(path + '/'));
                for (const folder of subFolders) {
                    await this.db.delete('folders', folder.path);
                }
                
                return await this.db.delete('folders', path);
            }

            // Settings
            async getSetting(key, defaultValue = null) {
                await this.ensureReady();
                const value = await this.db.get('settings', key);
                return value !== undefined ? value : defaultValue;
            }

            async saveSetting(key, value) {
                await this.ensureReady();
                return await this.db.put('settings', value, key);
            }

            async getAllSettings() {
                await this.ensureReady();
                const settings = {};
                const keys = await this.db.getAllKeys('settings');
                for (const key of keys) {
                    settings[key] = await this.db.get('settings', key);
                }
                return settings;
            }

            // Sessions (for auto-save recovery)
            async saveSession(session) {
                await this.ensureReady();
                session.timestamp = Date.now();
                return await this.db.add('sessions', session);
            }

            async getLatestSession() {
                await this.ensureReady();
                const sessions = await this.db.getAll('sessions');
                return sessions.sort((a, b) => b.timestamp - a.timestamp)[0];
            }

            async clearOldSessions(maxAge = 24 * 60 * 60 * 1000) { // 24 hours
                await this.ensureReady();
                const sessions = await this.db.getAll('sessions');
                const now = Date.now();
                for (const session of sessions) {
                    if (now - session.timestamp > maxAge) {
                        await this.db.delete('sessions', session.id);
                    }
                }
            }

            // Storage stats
            async getStorageStats() {
                await this.ensureReady();
                const files = await this.getAllFiles();
                const totalSize = files.reduce((sum, f) => sum + (f.size || 0), 0);
                const fileCount = files.length;
                const folders = await this.getAllFolders();
                
                let quota = 50 * 1024 * 1024; // Default 50MB
                let usage = totalSize;
                
                if (navigator.storage && navigator.storage.estimate) {
                    const estimate = await navigator.storage.estimate();
                    quota = estimate.quota || quota;
                    usage = estimate.usage || usage;
                }
                
                return {
                    usage,
                    quota,
                    percentage: (usage / quota) * 100,
                    fileCount,
                    folderCount: folders.length
                };
            }
        }

        // ==================== File Manager ====================
        class FileManager {
            constructor(db, notifications) {
                this.db = db;
                this.notifications = notifications;
                this.currentFile = null;
                this.selectedFile = null;
                this.openFiles = new Map(); // path -> file
                this.modifiedFiles = new Set();
                this.fileTree = null;
                this.contextMenuTarget = null;
                this.init();
            }

            async init() {
                await this.loadFiles();
                this.setupEventListeners();
                this.renderFileTree();
            }

            async loadFiles() {
                try {
                    const files = await this.db.getAllFiles();
                    const folders = await this.db.getAllFolders();
                    
                    this.fileTree = this.buildFileTree(files, folders);
                } catch (error) {
                    console.error('Failed to load files:', error);
                    this.notifications.error('Failed to load files from database');
                }
            }

            buildFileTree(files, folders) {
                const tree = {
                    name: 'root',
                    path: '',
                    type: 'folder',
                    children: new Map(),
                    files: []
                };

                // Add folders to tree
                folders.sort((a, b) => a.path.localeCompare(b.path));
                for (const folder of folders) {
                    const parts = folder.path.split('/');
                    let current = tree;
                    
                    for (let i = 0; i < parts.length; i++) {
                        const part = parts[i];
                        if (!current.children.has(part)) {
                            current.children.set(part, {
                                name: part,
                                path: parts.slice(0, i + 1).join('/'),
                                type: 'folder',
                                children: new Map(),
                                files: []
                            });
                        }
                        current = current.children.get(part);
                    }
                }

                // Add files to tree
                for (const file of files) {
                    const parts = file.path.split('/');
                    if (parts.length === 1) {
                        tree.files.push(file);
                    } else {
                        const folderPath = parts.slice(0, -1).join('/');
                        this.addFileToTree(tree, folderPath, file);
                    }
                }

                return tree;
            }

            addFileToTree(tree, folderPath, file) {
                const parts = folderPath.split('/');
                let current = tree;
                
                for (const part of parts) {
                    if (current.children.has(part)) {
                        current = current.children.get(part);
                    } else {
                        return;
                    }
                }
                
                current.files.push(file);
            }

            renderFileTree() {
                const explorer = document.getElementById('file-explorer');
                if (!explorer) return;
                
                explorer.innerHTML = '';
                const treeElement = this.createTreeElement(this.fileTree);
                explorer.appendChild(treeElement);
            }

            createTreeElement(node, level = 0) {
                const container = document.createElement('ul');
                container.className = 'file-tree';
                
                // Add folders first
                const folders = Array.from(node.children.values()).sort((a, b) => a.name.localeCompare(b.name));
                for (const folder of folders) {
                    const li = document.createElement('li');
                    li.className = 'file-tree-item';
                    
                    const header = document.createElement('div');
                    header.className = 'file-tree-header';
                    header.innerHTML = `
                        <i class="fas fa-chevron-right"></i>
                        <i class="fas fa-folder"></i>
                        <span class="file-name">${folder.name}</span>
                        <span class="file-size">${folder.files.length}</span>
                    `;
                    
                    header.addEventListener('click', (e) => {
                        e.stopPropagation();
                        header.classList.toggle('expanded');
                        const children = li.querySelector('.file-tree-children');
                        if (children) {
                            children.classList.toggle('expanded');
                        }
                    });
                    
                    header.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        this.showContextMenu(e, folder, 'folder');
                    });
                    
                    li.appendChild(header);
                    
                    const childrenContainer = document.createElement('ul');
                    childrenContainer.className = 'file-tree-children';
                    childrenContainer.appendChild(this.createTreeElement(folder, level + 1));
                    
                    li.appendChild(childrenContainer);
                    container.appendChild(li);
                }
                
                // Add files
                for (const file of node.files.sort((a, b) => a.name.localeCompare(b.name))) {
                    const li = document.createElement('li');
                    li.className = 'file-tree-item';
                    
                    const fileElement = this.createFileElement(file);
                    li.appendChild(fileElement);
                    container.appendChild(li);
                }
                
                return container;
            }

            createFileElement(file) {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.dataset.path = file.path;
                
                const language = CONFIG.SUPPORTED_LANGUAGES.find(l => l.extension === file.extension) || 
                                CONFIG.SUPPORTED_LANGUAGES.find(l => l.id === file.type) ||
                                CONFIG.SUPPORTED_LANGUAGES[CONFIG.SUPPORTED_LANGUAGES.length - 1];
                
                div.innerHTML = `
                    <i class="${language.icon}" style="color: ${language.color};"></i>
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${this.formatFileSize(file.size)}</span>
                    <div class="file-actions-menu">
                        <span class="file-action-icon" data-action="rename" title="Rename"><i class="fas fa-edit"></i></span>
                        <span class="file-action-icon" data-action="delete" title="Delete"><i class="fas fa-trash"></i></span>
                        <span class="file-action-icon" data-action="download" title="Download"><i class="fas fa-download"></i></span>
                    </div>
                `;
                
                div.addEventListener('click', (e) => {
                    if (!e.target.closest('.file-action-icon')) {
                        this.openFile(file);
                    }
                });
                
                div.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.showContextMenu(e, file, 'file');
                });
                
                // Action buttons
                div.querySelectorAll('.file-action-icon').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const action = btn.dataset.action;
                        this.handleFileAction(action, file);
                    });
                });
                
                return div;
            }

            formatFileSize(bytes) {
                if (!bytes || bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            }

            async openFile(file) {
                try {
                    const fullFile = await this.db.getFile(file.path);
                    if (!fullFile) {
                        this.notifications.error('File not found');
                        return;
                    }
                    
                    this.currentFile = fullFile;
                    this.selectedFile = fullFile;
                    
                    // Add to open files
                    this.openFiles.set(file.path, fullFile);
                    
                    // Update UI
                    this.updateEditorTabs();
                    this.switchToEditor(file.type);
                    
                    // Load content into editor
                    const editor = editors[file.type];
                    if (editor) {
                        editor.setValue(fullFile.content || '');
                    }
                    
                    // Update active state in file tree
                    document.querySelectorAll('.file-item').forEach(el => {
                        el.classList.remove('active');
                    });
                    const activeElement = document.querySelector(`.file-item[data-path="${file.path}"]`);
                    if (activeElement) {
                        activeElement.classList.add('active');
                    }
                    
                } catch (error) {
                    console.error('Error opening file:', error);
                    this.notifications.error('Failed to open file');
                }
            }

            async saveFile(file = this.currentFile) {
                if (!file) return;
                
                try {
                    const editor = editors[file.type];
                    if (editor) {
                        file.content = editor.getValue();
                    }
                    
                    await this.db.saveFile(file);
                    this.modifiedFiles.delete(file.path);
                    
                    // Update tab indicator
                    const tab = document.querySelector(`.editor-tab[data-path="${file.path}"]`);
                    if (tab) {
                        tab.classList.remove('modified');
                    }
                    
                    this.notifications.success(`Saved: ${file.name}`);
                    
                } catch (error) {
                    console.error('Error saving file:', error);
                    this.notifications.error('Failed to save file');
                }
            }

            async saveAllFiles() {
                const promises = [];
                for (const path of this.modifiedFiles) {
                    const file = this.openFiles.get(path);
                    if (file) {
                        promises.push(this.saveFile(file));
                    }
                }
                await Promise.all(promises);
                this.notifications.success('All files saved');
            }

            async createFile(name, type, folder = '') {
                try {
                    const extension = CONFIG.SUPPORTED_LANGUAGES.find(l => l.id === type)?.extension || '.txt';
                    const fileName = name.endsWith(extension) ? name : name + extension;
                    const path = folder ? `${folder}/${fileName}` : fileName;
                    
                    // Check if file exists
                    const existing = await this.db.getFile(path);
                    if (existing) {
                        this.notifications.error('File already exists');
                        return null;
                    }
                    
                    const file = {
                        path,
                        name: fileName,
                        type,
                        extension,
                        content: this.getDefaultContent(type, fileName),
                        created: Date.now(),
                        modified: Date.now(),
                        size: 0,
                        folder
                    };
                    
                    file.size = new Blob([file.content]).size;
                    
                    await this.db.saveFile(file);
                    await this.loadFiles();
                    this.renderFileTree();
                    
                    this.notifications.success(`Created: ${fileName}`);
                    return file;
                    
                } catch (error) {
                    console.error('Error creating file:', error);
                    this.notifications.error('Failed to create file');
                    return null;
                }
            }

            async createFolder(name, parent = '') {
                try {
                    const path = parent ? `${parent}/${name}` : name;
                    
                    // Check if folder exists
                    const existing = await this.db.getFolder(path);
                    if (existing) {
                        this.notifications.error('Folder already exists');
                        return null;
                    }
                    
                    const folder = {
                        path,
                        name,
                        parent,
                        created: Date.now(),
                        modified: Date.now()
                    };
                    
                    await this.db.saveFolder(folder);
                    await this.loadFiles();
                    this.renderFileTree();
                    
                    this.notifications.success(`Created folder: ${name}`);
                    return folder;
                    
                } catch (error) {
                    console.error('Error creating folder:', error);
                    this.notifications.error('Failed to create folder');
                    return null;
                }
            }

            async deleteFile(path) {
                try {
                    await this.db.deleteFile(path);
                    
                    // Remove from open files
                    this.openFiles.delete(path);
                    this.modifiedFiles.delete(path);
                    
                    // Update UI
                    if (this.currentFile?.path === path) {
                        this.currentFile = null;
                        // Switch to next available file
                        const nextFile = this.openFiles.values().next().value;
                        if (nextFile) {
                            await this.openFile(nextFile);
                        } else {
                            // Clear editor
                            Object.values(editors).forEach(e => e.setValue(''));
                            this.updateEditorTabs();
                        }
                    }
                    
                    await this.loadFiles();
                    this.renderFileTree();
                    
                    this.notifications.success('File deleted');
                    
                } catch (error) {
                    console.error('Error deleting file:', error);
                    this.notifications.error('Failed to delete file');
                }
            }

            async deleteFolder(path) {
                try {
                    await this.db.deleteFolder(path);
                    
                    // Remove all files in folder from open files
                    const files = await this.db.getFilesInFolder(path);
                    for (const file of files) {
                        this.openFiles.delete(file.path);
                        this.modifiedFiles.delete(file.path);
                    }
                    
                    await this.loadFiles();
                    this.renderFileTree();
                    
                    this.notifications.success('Folder deleted');
                    
                } catch (error) {
                    console.error('Error deleting folder:', error);
                    this.notifications.error('Failed to delete folder');
                }
            }

            async renameFile(oldPath, newName) {
                try {
                    const file = await this.db.getFile(oldPath);
                    if (!file) {
                        this.notifications.error('File not found');
                        return;
                    }
                    
                    const folder = file.folder || '';
                    const newPath = folder ? `${folder}/${newName}` : newName;
                    
                    // Check if new path exists
                    const existing = await this.db.getFile(newPath);
                    if (existing) {
                        this.notifications.error('File already exists');
                        return;
                    }
                    
                    // Delete old file
                    await this.db.deleteFile(oldPath);
                    
                    // Update file
                    file.path = newPath;
                    file.name = newName;
                    file.modified = Date.now();
                    
                    await this.db.saveFile(file);
                    
                    // Update open files
                    if (this.openFiles.has(oldPath)) {
                        this.openFiles.delete(oldPath);
                        this.openFiles.set(newPath, file);
                    }
                    
                    if (this.currentFile?.path === oldPath) {
                        this.currentFile = file;
                    }
                    
                    await this.loadFiles();
                    this.renderFileTree();
                    
                    this.notifications.success('File renamed');
                    
                } catch (error) {
                    console.error('Error renaming file:', error);
                    this.notifications.error('Failed to rename file');
                }
            }

            async duplicateFile(path) {
                try {
                    const file = await this.db.getFile(path);
                    if (!file) {
                        this.notifications.error('File not found');
                        return;
                    }
                    
                    const folder = file.folder || '';
                    const nameWithoutExt = file.name.replace(/\.[^/.]+$/, '');
                    const extension = file.extension;
                    
                    let counter = 1;
                    let newName, newPath;
                    
                    do {
                        newName = `${nameWithoutExt} (${counter})${extension}`;
                        newPath = folder ? `${folder}/${newName}` : newName;
                        counter++;
                    } while (await this.db.getFile(newPath));
                    
                    const newFile = {
                        ...file,
                        path: newPath,
                        name: newName,
                        created: Date.now(),
                        modified: Date.now()
                    };
                    
                    await this.db.saveFile(newFile);
                    await this.loadFiles();
                    this.renderFileTree();
                    
                    this.notifications.success('File duplicated');
                    
                } catch (error) {
                    console.error('Error duplicating file:', error);
                    this.notifications.error('Failed to duplicate file');
                }
            }

            async downloadFile(file) {
                try {
                    const content = file.content || '';
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                } catch (error) {
                    console.error('Error downloading file:', error);
                    this.notifications.error('Failed to download file');
                }
            }

            async exportProject() {
                try {
                    const files = await this.db.getAllFiles();
                    const folders = await this.db.getAllFolders();
                    const settings = await this.db.getAllSettings();
                    
                    const project = {
                        name: CONFIG.APP_NAME,
                        version: CONFIG.APP_VERSION,
                        exported: new Date().toISOString(),
                        files,
                        folders,
                        settings
                    };
                    
                    const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `project-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    this.notifications.success('Project exported successfully');
                    
                } catch (error) {
                    console.error('Error exporting project:', error);
                    this.notifications.error('Failed to export project');
                }
            }

            async importProject(file) {
                try {
                    const content = await file.text();
                    const project = JSON.parse(content);
                    
                    if (!project.files || !Array.isArray(project.files)) {
                        throw new Error('Invalid project file');
                    }
                    
                    // Clear existing data
                    const existingFiles = await this.db.getAllFiles();
                    for (const f of existingFiles) {
                        await this.db.deleteFile(f.path);
                    }
                    
                    const existingFolders = await this.db.getAllFolders();
                    for (const f of existingFolders) {
                        await this.db.deleteFolder(f.path);
                    }
                    
                    // Import new data
                    for (const folder of project.folders || []) {
                        await this.db.saveFolder(folder);
                    }
                    
                    for (const file of project.files) {
                        await this.db.saveFile(file);
                    }
                    
                    if (project.settings) {
                        for (const [key, value] of Object.entries(project.settings)) {
                            await this.db.saveSetting(key, value);
                        }
                    }
                    
                    await this.loadFiles();
                    this.renderFileTree();
                    
                    this.notifications.success('Project imported successfully');
                    
                } catch (error) {
                    console.error('Error importing project:', error);
                    this.notifications.error('Failed to import project: ' + error.message);
                }
            }

            getDefaultContent(type, fileName) {
                const templates = {
                    html: `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${fileName.replace('.html', '')}</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>Welcome to ${fileName.replace('.html', '')}</h1>
    </header>
    
    <main>
        <p>Start editing this HTML file!</p>
    </main>
    
    <script src="script.js"></script>
</body>
</html>`,
                    
                    css: `/* ${fileName} */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    line-height: 1.6;
    color: #333;
    background: #f5f5f5;
}

header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    text-align: center;
}

main {
    max-width: 800px;
    margin: 2rem auto;
    padding: 0 1rem;
}`,
                    
                    javascript: `// ${fileName}
'use strict';

// Main application code
document.addEventListener('DOMContentLoaded', () => {
    console.log('${fileName} loaded successfully!');
    
    // Add your code here
    initialize();
});

function initialize() {
    console.log('Application initialized');
}

// Utility functions
const formatDate = (date) => {
    return new Intl.DateTimeFormat('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    }).format(date);
};`,
                    
                    python: `#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
${fileName} - Python Module
"""

import sys
import os

def main():
    """Main entry point"""
    print("Hello from ${fileName}!")
    print(f"Python version: {sys.version}")
    
    # Add your code here
    result = calculate(5, 3)
    print(f"5 + 3 = {result}")

def calculate(a, b):
    """Example calculation function"""
    return a + b

if __name__ == "__main__":
    main()`,
                    
                    default: `// ${fileName}\n// Created: ${new Date().toLocaleString()}\n\n`
                };
                
                return templates[type] || templates.default;
            }

            updateEditorTabs() {
                const tabsContainer = document.getElementById('editor-tabs');
                if (!tabsContainer) return;
                
                tabsContainer.innerHTML = '';
                
                for (const [path, file] of this.openFiles) {
                    const tab = document.createElement('div');
                    tab.className = 'editor-tab';
                    if (this.modifiedFiles.has(path)) {
                        tab.classList.add('modified');
                    }
                    if (this.currentFile?.path === path) {
                        tab.classList.add('active');
                    }
                    tab.dataset.path = path;
                    
                    const language = CONFIG.SUPPORTED_LANGUAGES.find(l => l.id === file.type) || 
                                    CONFIG.SUPPORTED_LANGUAGES[CONFIG.SUPPORTED_LANGUAGES.length - 1];
                    
                    tab.innerHTML = `
                        <i class="${language.icon}" style="color: ${language.color};"></i>
                        <span class="tab-name">${file.name}</span>
                        <span class="tab-close" onclick="fileManager.closeFile('${path}')">&times;</span>
                    `;
                    
                    tab.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('tab-close')) {
                            this.openFile(file);
                        }
                    });
                    
                    tabsContainer.appendChild(tab);
                }
            }

            async closeFile(path) {
                if (this.modifiedFiles.has(path)) {
                    if (!confirm('File has unsaved changes. Close anyway?')) {
                        return;
                    }
                }
                
                this.openFiles.delete(path);
                this.modifiedFiles.delete(path);
                
                if (this.currentFile?.path === path) {
                    const nextFile = this.openFiles.values().next().value;
                    if (nextFile) {
                        await this.openFile(nextFile);
                    } else {
                        this.currentFile = null;
                        Object.values(editors).forEach(e => e.setValue(''));
                    }
                }
                
                this.updateEditorTabs();
            }

            switchToEditor(language) {
                document.querySelectorAll('.editor-wrapper').forEach(w => {
                    w.classList.remove('active');
                });
                
                const wrapper = document.querySelector(`.editor-wrapper[data-language="${language}"]`);
                if (wrapper) {
                    wrapper.classList.add('active');
                }
            }

            handleFileAction(action, file) {
                switch (action) {
                    case 'rename':
                        const newName = prompt('Enter new name:', file.name);
                        if (newName && newName !== file.name) {
                            this.renameFile(file.path, newName);
                        }
                        break;
                        
                    case 'delete':
                        if (confirm(`Delete "${file.name}"?`)) {
                            this.deleteFile(file.path);
                        }
                        break;
                        
                    case 'download':
                        this.downloadFile(file);
                        break;
                        
                    case 'duplicate':
                        this.duplicateFile(file.path);
                        break;
                }
            }

            showContextMenu(e, target, type) {
                e.preventDefault();
                this.contextMenuTarget = { target, type };
                
                const menu = document.getElementById('context-menu');
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
                menu.style.display = 'block';
                
                const hideMenu = () => {
                    menu.style.display = 'none';
                    document.removeEventListener('click', hideMenu);
                };
                
                setTimeout(() => {
                    document.addEventListener('click', hideMenu);
                }, 100);
            }

            setupEventListeners() {
                // Context menu actions
                document.querySelectorAll('#context-menu .context-menu-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const action = item.dataset.action;
                        if (this.contextMenuTarget) {
                            const { target, type } = this.contextMenuTarget;
                            this.handleFileAction(action, target);
                        }
                    });
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', async (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        await this.saveFile();
                    }
                    
                    if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'S') {
                        e.preventDefault();
                        await this.saveAllFiles();
                    }
                    
                    if ((e.ctrlKey || e.metaKey) && e.key === 'w') {
                        e.preventDefault();
                        if (this.currentFile) {
                            await this.closeFile(this.currentFile.path);
                        }
                    }
                    
                    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                        e.preventDefault();
                        showModal('new-file-modal');
                    }
                });
            }
        }

        // ==================== Editor Manager ====================
        class EditorManager {
            constructor() {
                this.editors = {};
                this.currentTheme = 'vs';
                this.initPromise = this.init();
            }

            async init() {
                return new Promise((resolve) => {
                    require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs' } });
                    
                    require(['vs/editor/editor.main'], () => {
                        this.createEditors();
                        this.setupThemes();
                        resolve();
                    });
                });
            }

            createEditors() {
                this.editors.html = monaco.editor.create(document.getElementById('html-editor'), {
                    value: '',
                    language: 'html',
                    theme: this.currentTheme,
                    automaticLayout: true,
                    minimap: { enabled: false },
                    fontSize: 14,
                    wordWrap: 'on',
                    lineNumbers: 'on',
                    renderWhitespace: 'selection',
                    bracketPairColorization: { enabled: true },
                    guides: { bracketPairs: true }
                });
                
                this.editors.css = monaco.editor.create(document.getElementById('css-editor'), {
                    value: '',
                    language: 'css',
                    theme: this.currentTheme,
                    automaticLayout: true,
                    minimap: { enabled: false }
                });
                
                this.editors.javascript = monaco.editor.create(document.getElementById('js-editor'), {
                    value: '',
                    language: 'javascript',
                    theme: this.currentTheme,
                    automaticLayout: true,
                    minimap: { enabled: false }
                });
                
                this.editors.python = monaco.editor.create(document.getElementById('python-editor'), {
                    value: '',
                    language: 'python',
                    theme: this.currentTheme,
                    automaticLayout: true,
                    minimap: { enabled: false }
                });
                
                // Add change listeners
                Object.entries(this.editors).forEach(([lang, editor]) => {
                    editor.onDidChangeModelContent(() => {
                        if (fileManager && fileManager.currentFile && fileManager.currentFile.type === lang) {
                            fileManager.modifiedFiles.add(fileManager.currentFile.path);
                            fileManager.updateEditorTabs();
                        }
                    });
                });
            }

            setupThemes() {
                monaco.editor.defineTheme('custom-dark', {
                    base: 'vs-dark',
                    inherit: true,
                    rules: [],
                    colors: {
                        'editor.background': '#1e1e1e',
                        'editor.foreground': '#d4d4d4',
                        'editor.lineHighlightBackground': '#2a2a2a',
                        'editorCursor.foreground': '#aeafad',
                        'editorWhitespace.foreground': '#3b3b3b'
                    }
                });
            }

            setTheme(theme) {
                this.currentTheme = theme;
                monaco.editor.setTheme(theme);
            }

            format(language) {
                const editor = this.editors[language];
                if (!editor) return;
                
                editor.getAction('editor.action.formatDocument').run();
            }

            async getValue(language) {
                return this.editors[language]?.getValue() || '';
            }

            async setValue(language, value) {
                if (this.editors[language]) {
                    this.editors[language].setValue(value || '');
                }
            }

            async lintJavaScript() {
                const code = await this.getValue('javascript');
                // Basic linting - in production, use ESLint or similar
                const errors = [];
                
                // Check for common issues
                if (code.includes('debugger;')) {
                    errors.push('Found debugger statement');
                }
                
                if (code.includes('console.log') && code.includes('production')) {
                    errors.push('Console.log found in production code');
                }
                
                if (errors.length > 0) {
                    notifications.warning(errors.join('\n'), 'Lint Warnings');
                } else {
                    notifications.success('No linting issues found');
                }
            }
        }

        // ==================== Preview Manager ====================
        class PreviewManager {
            constructor() {
                this.frame = document.getElementById('preview-frame');
                this.isMobile = false;
                this.isFullscreen = false;
                this.originalConsole = { ...console };
            }

            async update(html, css, js) {
                try {
                    const previewDocument = this.frame.contentDocument || this.frame.contentWindow.document;
                    
                    previewDocument.open();
                    previewDocument.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <style>${css}</style>
                            <script>
                                // Capture console output
                                const originalConsole = { ...console };
                                const consoleOutput = [];
                                
                                ['log', 'error', 'warn', 'info', 'debug'].forEach(method => {
                                    console[method] = (...args) => {
                                        consoleOutput.push({
                                            method,
                                            args,
                                            timestamp: Date.now()
                                        });
                                        originalConsole[method](...args);
                                        
                                        // Send to parent
                                        window.parent.postMessage({
                                            type: 'console',
                                            method,
                                            args: args.map(a => {
                                                try {
                                                    return JSON.stringify(a);
                                                } catch {
                                                    return String(a);
                                                }
                                            }).join(' ')
                                        }, '*');
                                    };
                                });
                                
                                // Handle errors
                                window.addEventListener('error', (e) => {
                                    console.error(e.error || e.message);
                                });
                                
                                window.addEventListener('unhandledrejection', (e) => {
                                    console.error('Unhandled Promise Rejection:', e.reason);
                                });
                            </script>
                        </head>
                        <body>
                            ${html}
                            <script>${js}<\/script>
                        </body>
                        </html>
                    `);
                    previewDocument.close();
                    
                } catch (error) {
                    console.error('Preview update failed:', error);
                    notifications.error('Failed to update preview');
                }
            }

            toggleMobile() {
                this.isMobile = !this.isMobile;
                if (this.isMobile) {
                    this.frame.classList.add('mobile-view');
                } else {
                    this.frame.classList.remove('mobile-view');
                }
            }

            toggleFullscreen() {
                this.isFullscreen = !this.isFullscreen;
                const panel = document.getElementById('preview-panel');
                if (this.isFullscreen) {
                    panel.classList.add('fullscreen');
                } else {
                    panel.classList.remove('fullscreen');
                }
            }

            refresh() {
                const iframe = this.frame;
                iframe.src = iframe.src;
            }

            setupMessageListener() {
                window.addEventListener('message', (event) => {
                    if (event.data.type === 'console') {
                        const { method, args } = event.data;
                        consoleManager.addMessage(method, args);
                    }
                });
            }
        }

        // ==================== Console Manager ====================
        class ConsoleManager {
            constructor() {
                this.output = document.getElementById('console-output');
                this.messages = [];
                this.maxMessages = 1000;
            }

            addMessage(type, content) {
                const message = {
                    type,
                    content,
                    timestamp: new Date().toLocaleTimeString()
                };
                
                this.messages.push(message);
                if (this.messages.length > this.maxMessages) {
                    this.messages.shift();
                }
                
                this.renderMessage(message);
            }

            renderMessage(message) {
                const line = document.createElement('div');
                line.className = `console-line ${message.type}`;
                line.innerHTML = `
                    <span class="console-timestamp">[${message.timestamp}]</span>
                    ${this.escapeHtml(message.content)}
                `;
                
                this.output.appendChild(line);
                this.output.scrollTop = this.output.scrollHeight;
            }

            clear() {
                this.messages = [];
                this.output.innerHTML = '';
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // ==================== PWA Manager ====================
        class PWAManager {
            constructor() {
                this.deferredPrompt = null;
                this.swRegistration = null;
                this.init();
            }

            async init() {
                if ('serviceWorker' in navigator) {
                    try {
                        this.swRegistration = await navigator.serviceWorker.register('/sw.js');
                        console.log('Service Worker registered');
                        
                        // Check for updates
                        this.swRegistration.addEventListener('updatefound', () => {
                            const newWorker = this.swRegistration.installing;
                            notifications.info('New version available!');
                        });
                        
                    } catch (error) {
                        console.error('Service Worker registration failed:', error);
                    }
                }
                
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    document.getElementById('install-pwa').style.display = 'inline-block';
                });
                
                window.addEventListener('appinstalled', () => {
                    this.deferredPrompt = null;
                    notifications.success('App installed successfully!');
                });
                
                this.setupOfflineDetection();
            }

            setupOfflineDetection() {
                const updateOnlineStatus = () => {
                    const status = document.getElementById('online-status');
                    const indicator = document.getElementById('offline-indicator');
                    
                    if (navigator.onLine) {
                        status.className = 'status-indicator online';
                        status.innerHTML = '<i class="fas fa-circle"></i><span>Online</span>';
                        if (indicator) indicator.style.display = 'none';
                    } else {
                        status.className = 'status-indicator offline';
                        status.innerHTML = '<i class="fas fa-circle"></i><span>Offline</span>';
                        notifications.warning('You are offline. Changes will be saved locally.');
                    }
                };
                
                window.addEventListener('online', updateOnlineStatus);
                window.addEventListener('offline', updateOnlineStatus);
                updateOnlineStatus();
            }

            async install() {
                if (!this.deferredPrompt) {
                    notifications.info('App already installed or not installable');
                    return;
                }
                
                this.deferredPrompt.prompt();
                const { outcome } = await this.deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    notifications.success('Installing app...');
                }
                
                this.deferredPrompt = null;
            }

            async checkForUpdates() {
                if (!this.swRegistration) {
                    notifications.warning('Service Worker not registered');
                    return;
                }
                
                try {
                    await this.swRegistration.update();
                    notifications.success('Checking for updates...');
                } catch (error) {
                    notifications.error('Failed to check for updates');
                }
            }

            async clearCache() {
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(
                        cacheNames.map(name => caches.delete(name))
                    );
                    notifications.success('Cache cleared');
                }
            }
        }

        // ==================== Global State ====================
        const notifications = new NotificationSystem();
        let db;
        let fileManager;
        let editorManager;
        let previewManager;
        let consoleManager;
        let pwaManager;
        let editors = {};

        // ==================== UI Helpers ====================
        function showModal(modalId) {
            document.getElementById(modalId)?.classList.add('show');
        }

        function hideModal(modalId) {
            document.getElementById(modalId)?.classList.remove('show');
        }

        // ==================== Main Initialization ====================
        async function initApp() {
            try {
                notifications.info('Initializing SupremeAmer IDE Pro...');
                
                // Initialize database
                db = new DatabaseService();
                await db.init();
                
                // Initialize managers
                editorManager = new EditorManager();
                await editorManager.initPromise;
                editors = editorManager.editors;
                
                consoleManager = new ConsoleManager();
                previewManager = new PreviewManager();
                pwaManager = new PWAManager();
                
                fileManager = new FileManager(db, notifications);
                
                // Setup event listeners
                setupEventListeners();
                
                // Load settings
                await loadSettings();
                
                // Check for recovery session
                await checkRecoverySession();
                
                // Update storage info
                await updateStorageInfo();
                
                // Start auto-save
                startAutoSave();
                
                notifications.success('IDE initialized successfully!');
                
            } catch (error) {
                console.error('Initialization failed:', error);
                notifications.error('Failed to initialize IDE: ' + error.message);
            }
        }

        function setupEventListeners() {
            // Run code
            document.getElementById('run-code')?.addEventListener('click', runCode);
            
            // Save file
            document.getElementById('save-file')?.addEventListener('click', () => fileManager.saveFile());
            
            // New file
            document.getElementById('new-file')?.addEventListener('click', () => showModal('new-file-modal'));
            document.getElementById('sidebar-new-file')?.addEventListener('click', () => showModal('new-file-modal'));
            
            // New folder
            document.getElementById('new-folder')?.addEventListener('click', createNewFolder);
            document.getElementById('sidebar-new-folder')?.addEventListener('click', createNewFolder);
            
            // Upload files
            document.getElementById('upload-files')?.addEventListener('click', () => {
                document.getElementById('file-input').click();
            });
            
            // Export project
            document.getElementById('export-project')?.addEventListener('click', () => fileManager.exportProject());
            
            // Theme toggle
            document.getElementById('toggle-theme')?.addEventListener('click', toggleTheme);
            
            // PWA settings
            document.getElementById('pwa-settings')?.addEventListener('click', () => showModal('pwa-modal'));
            
            // Sidebar toggle
            document.getElementById('toggle-sidebar')?.addEventListener('click', toggleSidebar);
            document.getElementById('close-sidebar')?.addEventListener('click', toggleSidebar);
            
            // Preview controls
            document.getElementById('refresh-preview')?.addEventListener('click', () => previewManager.refresh());
            document.getElementById('toggle-device')?.addEventListener('click', () => previewManager.toggleMobile());
            document.getElementById('toggle-preview-fullscreen')?.addEventListener('click', () => previewManager.toggleFullscreen());
            
            // Console
            document.getElementById('clear-console')?.addEventListener('click', () => consoleManager.clear());
            
            // Create file modal
            document.getElementById('create-file-btn')?.addEventListener('click', createNewFile);
            
            // File input
            document.getElementById('file-input')?.addEventListener('change', handleFileUpload);
            
            // Drop zone
            setupDropZone();
            
            // Settings
            document.getElementById('save-settings')?.addEventListener('click', saveSettings);
            
            // Format buttons
            document.getElementById('format-html')?.addEventListener('click', () => editorManager.format('html'));
            document.getElementById('format-css')?.addEventListener('click', () => editorManager.format('css'));
            document.getElementById('format-js')?.addEventListener('click', () => editorManager.format('javascript'));
            
            // Lint JS
            document.getElementById('lint-js')?.addEventListener('click', () => editorManager.lintJavaScript());
            
            // Theme selector
            document.getElementById('html-theme')?.addEventListener('change', (e) => {
                editorManager.setTheme(e.target.value);
            });
            
            // Preview message listener
            previewManager.setupMessageListener();
        }

        async function runCode() {
            try {
                const html = await editorManager.getValue('html');
                const css = await editorManager.getValue('css');
                const js = await editorManager.getValue('javascript');
                
                consoleManager.clear();
                consoleManager.addMessage('info', 'Running code...');
                
                await previewManager.update(html, css, js);
                
                consoleManager.addMessage('success', 'Code executed successfully');
                
            } catch (error) {
                console.error('Run error:', error);
                consoleManager.addMessage('error', 'Error: ' + error.message);
            }
        }

        async function createNewFile() {
            const name = document.getElementById('new-file-name').value.trim();
            const folder = document.getElementById('new-file-folder').value.trim();
            const selectedLang = document.querySelector('#language-grid .language-option.selected');
            
            if (!name) {
                notifications.error('Please enter a file name');
                return;
            }
            
            const type = selectedLang?.dataset.type || 'plaintext';
            
            const file = await fileManager.createFile(name, type, folder);
            if (file) {
                hideModal('new-file-modal');
                await fileManager.openFile(file);
            }
        }

        async function createNewFolder() {
            const name = prompt('Enter folder name:');
            if (name && name.trim()) {
                await fileManager.createFolder(name.trim());
            }
        }

        async function handleFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            notifications.info(`Uploading ${files.length} files...`);
            
            for (const file of files) {
                try {
                    const content = await file.text();
                    const extension = file.name.split('.').pop();
                    const type = CONFIG.SUPPORTED_LANGUAGES.find(l => l.extension === `.${extension}`)?.id || 'plaintext';
                    
                    await fileManager.createFile(
                        file.name.replace(`.${extension}`, ''),
                        type,
                        '',
                        content
                    );
                    
                } catch (error) {
                    console.error('Error uploading file:', error);
                }
            }
            
            notifications.success('Files uploaded successfully');
        }

        function setupDropZone() {
            const dropZone = document.getElementById('drop-zone');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.add('dragover');
                });
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('dragover');
                });
            });
            
            dropZone.addEventListener('drop', async (e) => {
                const items = e.dataTransfer.items;
                const files = e.dataTransfer.files;
                
                if (items) {
                    for (const item of items) {
                        const entry = item.webkitGetAsEntry();
                        if (entry) {
                            await traverseFileTree(entry);
                        }
                    }
                } else {
                    for (const file of files) {
                        await handleUploadedFile(file);
                    }
                }
            });
            
            dropZone.addEventListener('click', () => {
                document.getElementById('file-input').click();
            });
        }

        async function traverseFileTree(entry, path = '') {
            if (entry.isFile) {
                const file = await new Promise((resolve) => entry.file(resolve));
                await handleUploadedFile(file, path);
            } else if (entry.isDirectory) {
                const dirReader = entry.createReader();
                const entries = await new Promise((resolve) => {
                    dirReader.readEntries(resolve);
                });
                
                for (const childEntry of entries) {
                    await traverseFileTree(childEntry, path ? `${path}/${entry.name}` : entry.name);
                }
            }
        }

        async function handleUploadedFile(file, folder = '') {
            try {
                const content = await file.text();
                const extension = file.name.split('.').pop();
                const type = CONFIG.SUPPORTED_LANGUAGES.find(l => l.extension === `.${extension}`)?.id || 'plaintext';
                const name = file.name.replace(`.${extension}`, '');
                
                await fileManager.createFile(name, type, folder, content);
                
            } catch (error) {
                console.error('Error handling uploaded file:', error);
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const btn = document.getElementById('toggle-theme');
            const icon = btn.querySelector('i');
            const span = btn.querySelector('span');
            
            if (document.body.classList.contains('dark-mode')) {
                icon.className = 'fas fa-sun';
                span.textContent = 'Light';
                editorManager.setTheme('vs-dark');
                document.getElementById('theme-color').setAttribute('content', '#1a1a2e');
            } else {
                icon.className = 'fas fa-moon';
                span.textContent = 'Dark';
                editorManager.setTheme('vs');
                document.getElementById('theme-color').setAttribute('content', '#2c3e50');
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }

        async function loadSettings() {
            const fontSize = await db.getSetting('fontSize', 14);
            const tabSize = await db.getSetting('tabSize', 4);
            const wordWrap = await db.getSetting('wordWrap', true);
            
            Object.values(editors).forEach(editor => {
                editor.updateOptions({
                    fontSize,
                    tabSize,
                    wordWrap: wordWrap ? 'on' : 'off'
                });
            });
            
            document.getElementById('setting-font-size').value = fontSize;
            document.getElementById('setting-tab-size').value = tabSize;
            document.getElementById('setting-word-wrap').checked = wordWrap;
        }

        async function saveSettings() {
            const fontSize = parseInt(document.getElementById('setting-font-size').value);
            const tabSize = parseInt(document.getElementById('setting-tab-size').value);
            const wordWrap = document.getElementById('setting-word-wrap').checked;
            const autoSave = document.getElementById('setting-auto-save').checked;
            const autoSaveInterval = parseInt(document.getElementById('setting-auto-save-interval').value);
            
            await db.saveSetting('fontSize', fontSize);
            await db.saveSetting('tabSize', tabSize);
            await db.saveSetting('wordWrap', wordWrap);
            await db.saveSetting('autoSave', autoSave);
            await db.saveSetting('autoSaveInterval', autoSaveInterval);
            
            Object.values(editors).forEach(editor => {
                editor.updateOptions({
                    fontSize,
                    tabSize,
                    wordWrap: wordWrap ? 'on' : 'off'
                });
            });
            
            hideModal('settings-modal');
            notifications.success('Settings saved');
        }

        async function updateStorageInfo() {
            try {
                const stats = await db.getStorageStats();
                const usedMB = (stats.usage / (1024 * 1024)).toFixed(2);
                const quotaMB = (stats.quota / (1024 * 1024)).toFixed(2);
                
                document.getElementById('storage-usage').textContent = `${usedMB}MB / ${quotaMB}MB`;
                document.getElementById('storage-progress').style.width = `${Math.min(stats.percentage, 100)}%`;
                
            } catch (error) {
                console.error('Error updating storage info:', error);
            }
        }

        async function checkRecoverySession() {
            try {
                const session = await db.getLatestSession();
                if (session && (Date.now() - session.timestamp) < 24 * 60 * 60 * 1000) {
                    if (confirm('Found unsaved session from last time. Would you like to recover it?')) {
                        // Recover session
                        for (const file of session.files || []) {
                            await fileManager.openFile(file);
                        }
                        notifications.success('Session recovered');
                    }
                }
            } catch (error) {
                console.error('Error checking recovery session:', error);
            }
        }

        function startAutoSave() {
            setInterval(async () => {
                const indicator = document.getElementById('auto-save-indicator');
                indicator.classList.add('show');
                
                try {
                    await fileManager.saveAllFiles();
                    
                    // Save session
                    const files = await db.getAllFiles();
                    await db.saveSession({ files, timestamp: Date.now() });
                    
                    await updateStorageInfo();
                    
                    setTimeout(() => {
                        indicator.classList.remove('show');
                    }, 2000);
                    
                } catch (error) {
                    console.error('Auto-save error:', error);
                    indicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Save failed</span>';
                    setTimeout(() => {
                        indicator.classList.remove('show');
                    }, 3000);
                }
            }, CONFIG.AUTO_SAVE_INTERVAL);
        }

        // Populate language grid
        function populateLanguageGrid() {
            const grid = document.getElementById('language-grid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            CONFIG.SUPPORTED_LANGUAGES.forEach(lang => {
                const option = document.createElement('div');
                option.className = `language-option ${lang.id === 'html' ? 'selected' : ''}`;
                option.dataset.type = lang.id;
                option.innerHTML = `
                    <div class="language-icon" style="color: ${lang.color};">
                        <i class="${lang.icon}"></i>
                    </div>
                    <div>${lang.extension}</div>
                `;
                
                option.addEventListener('click', function() {
                    document.querySelectorAll('.language-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
                
                grid.appendChild(option);
            });
        }

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            populateLanguageGrid();
            initApp();
        });
    </script>
</body>
</html>
